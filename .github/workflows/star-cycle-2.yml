name: Star Cycle Forever â™¡ï½
on:
  schedule:
    - cron: '*/15 * * * *'  # æ¯15åˆ†é’Ÿè¿è¡Œä¸€æ¬¡å–µï½
  workflow_dispatch:
    inputs:
      force_action:
        description: 'å¼ºåˆ¶æ‰§è¡Œæ“ä½œï¼ˆtrue/falseï¼‰- è‡ªåŠ¨åˆ¤æ–­å½“å‰çŠ¶æ€å¹¶æ‰§è¡Œç›¸åæ“ä½œ'
        required: false
        default: 'false'
        type: boolean

jobs:
  star-unstar-loop:
    runs-on: ubuntu-latest
    env:
      TARGET_OWNER: AstrBotDevs
      TARGET_REPO: AstrBot
      PERSONAL_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
      STAR_PERIOD_HOURS: 0.83
      UNSTAR_PERIOD_HOURS: 0.83
      FORCE_ACTION: ${{ github.event.inputs.force_action || 'false' }}

    steps:
      - name: Checkout repo (ç”¨äºè¯»å†™ star_timestamp.txt)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_TOKEN }}

      - name: å‡†å¤‡å°æ•°è¿ç®—ç¯å¢ƒ
        run: |
          echo "ä½¿ç”¨awkè¿›è¡Œå°æ•°è¿ç®—ï¼Œæ— éœ€é¢å¤–å®‰è£…åŒ… å–µï½"

      - name: æ£€æŸ¥ Token æœ‰æ•ˆæ€§å–µï½
        run: |
          echo "== è¯·æ±‚ç”¨æˆ·ä¿¡æ¯ ==" 
          curl -i -H "Authorization: token $PERSONAL_TOKEN" \
               -H "Accept: application/vnd.github+json" \
               https://api.github.com/user
      
      - name: æ£€æŸ¥å½“å‰æ˜Ÿæ ‡çŠ¶æ€å¹¶å†³å®šæ“ä½œå–µï½
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token $PERSONAL_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/user/starred/$TARGET_OWNER/$TARGET_REPO)
          NOW=$(date +%s)
          
          echo "=== å½“å‰æ—¶é—´: $(date) ==="
          echo "=== å½“å‰æ—¶é—´æˆ³: $NOW ==="
          echo "=== ç›®æ ‡ä»“åº“: $TARGET_OWNER/$TARGET_REPO ==="
          echo "=== å¼ºåˆ¶æ¨¡å¼: FORCE_ACTION=$FORCE_ACTION ==="
          
          # å°†å°æ—¶è½¬æ¢ä¸ºç§’ï¼ˆæ”¯æŒå°æ•°ï¼‰
          STAR_PERIOD_SECONDS=$(awk "BEGIN {printf \"%.0f\", $STAR_PERIOD_HOURS * 3600}")
          UNSTAR_PERIOD_SECONDS=$(awk "BEGIN {printf \"%.0f\", $UNSTAR_PERIOD_HOURS * 3600}")
          
          echo "=== æ˜Ÿæ ‡å‘¨æœŸ: $STAR_PERIOD_HOURS å°æ—¶ ($STAR_PERIOD_SECONDS ç§’) ==="
          echo "=== å–æ¶ˆæ˜Ÿæ ‡å‘¨æœŸ: $UNSTAR_PERIOD_HOURS å°æ—¶ ($UNSTAR_PERIOD_SECONDS ç§’) ==="
          
          if [ "$STATUS" != "204" ]; then
            echo "å½“å‰æœªåŠ æ˜Ÿï¼Œæ£€æŸ¥æ˜¯å¦è¯¥æ‰§è¡ŒåŠ æ˜Ÿæ“ä½œå–µï½"
            SHOULD_STAR=false
            
            if [ "$FORCE_ACTION" = "true" ]; then
              echo "ğŸ”¥ å¼ºåˆ¶æ“ä½œæ¨¡å¼ï¼šå½“å‰æœªåŠ æ˜Ÿ â†’ å¼ºåˆ¶åŠ æ˜Ÿå–µï½"
              SHOULD_STAR=true
            else
              if [ -f star_timestamp.txt ]; then
                LAST_OPERATION=$(head -n 1 star_timestamp.txt)
                echo "ä¸Šæ¬¡æ“ä½œè®°å½•: $LAST_OPERATION"
                
                if [[ "$LAST_OPERATION" == *":"* ]]; then
                  LAST_TIME=$(echo "$LAST_OPERATION" | cut -d: -f2)
                  LAST_ACTION=$(echo "$LAST_OPERATION" | cut -d: -f1)
                else
                  # å…¼å®¹æ—§æ ¼å¼ï¼ˆçº¯æ—¶é—´æˆ³ï¼‰
                  LAST_TIME="$LAST_OPERATION"
                  LAST_ACTION="star"
                fi
                
                DIFF_SECONDS=$(( NOW - LAST_TIME ))
                DIFF_HOURS=$(awk "BEGIN {printf \"%.2f\", $DIFF_SECONDS / 3600}")
                echo "è·ç¦»ä¸Šæ¬¡æ“ä½œå·²è¿‡: $DIFF_HOURS å°æ—¶ ($DIFF_SECONDS ç§’)"
                
                if [ "$LAST_ACTION" = "unstar" ]; then
                  if [ "$DIFF_SECONDS" -ge "$UNSTAR_PERIOD_SECONDS" ]; then
                    echo "è·ç¦»ä¸Šæ¬¡å–æ¶ˆæ˜Ÿæ ‡å·²è¿‡ $DIFF_HOURS å°æ—¶ï¼Œå¯ä»¥é‡æ–°åŠ æ˜Ÿå–µï½"
                    SHOULD_STAR=true
                  else
                    REMAIN_SECONDS=$(( UNSTAR_PERIOD_SECONDS - DIFF_SECONDS ))
                    REMAIN_HOURS=$(awk "BEGIN {printf \"%.2f\", $REMAIN_SECONDS / 3600}")
                    echo "è·ç¦»ä¸Šæ¬¡å–æ¶ˆæ˜Ÿæ ‡åªè¿‡äº† $DIFF_HOURS å°æ—¶ï¼Œè¿˜éœ€ç­‰å¾… $REMAIN_HOURS å°æ—¶å–µï½"
                  fi
                else
                  echo "ä¸Šæ¬¡æ“ä½œæ˜¯åŠ æ˜Ÿï¼Œä½†ç°åœ¨æœªåŠ æ˜Ÿï¼Œç›´æ¥åŠ æ˜Ÿå–µï½"
                  SHOULD_STAR=true
                fi
              else
                echo "æ²¡æœ‰æ—¶é—´æˆ³è®°å½•ï¼Œç›´æ¥åŠ æ˜Ÿå–µï½"
                SHOULD_STAR=true
              fi
            fi
            
            if [ "$SHOULD_STAR" = "true" ]; then
              echo "æ‰§è¡ŒåŠ æ˜Ÿæ“ä½œ..."
              CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                -X PUT \
                -H "Authorization: token $PERSONAL_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                https://api.github.com/user/starred/$TARGET_OWNER/$TARGET_REPO)
              if [ "$CODE" = "204" ]; then
                echo "star:$NOW" > star_timestamp.txt
                echo "âœ… Star æˆåŠŸå¹¶è®°å½•æ—¶é—´æˆ³å–µâ™¡"
              else
                echo "âŒ Star å¤±è´¥ï¼Œè¿”å›ç ï¼š$CODE"
                exit 1
              fi
            else
              echo "â³ æš‚ä¸æ‰§è¡ŒåŠ æ˜Ÿæ“ä½œ"
            fi
            
          else
            echo "å½“å‰å·²åŠ æ˜Ÿï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦å–æ¶ˆå–µï½"
            SHOULD_UNSTAR=false
            
            if [ "$FORCE_ACTION" = "true" ]; then
              echo "ğŸ”¥ å¼ºåˆ¶æ“ä½œæ¨¡å¼ï¼šå½“å‰å·²åŠ æ˜Ÿ â†’ å¼ºåˆ¶å–æ¶ˆæ˜Ÿæ ‡å–µï½"
              SHOULD_UNSTAR=true
            else
              if [ -f star_timestamp.txt ]; then
                LAST_OPERATION=$(head -n 1 star_timestamp.txt)
                echo "ä¸Šæ¬¡æ“ä½œè®°å½•: $LAST_OPERATION"
                
                if [[ "$LAST_OPERATION" == *":"* ]]; then
                  LAST_TIME=$(echo "$LAST_OPERATION" | cut -d: -f2)
                  LAST_ACTION=$(echo "$LAST_OPERATION" | cut -d: -f1)
                else
                  # å…¼å®¹æ—§æ ¼å¼ï¼ˆçº¯æ—¶é—´æˆ³ï¼‰
                  LAST_TIME="$LAST_OPERATION"
                  LAST_ACTION="star"
                fi
                
                DIFF_SECONDS=$(( NOW - LAST_TIME ))
                DIFF_HOURS=$(awk "BEGIN {printf \"%.2f\", $DIFF_SECONDS / 3600}")
                echo "è·ç¦»ä¸Šæ¬¡æ“ä½œå·²è¿‡: $DIFF_HOURS å°æ—¶ ($DIFF_SECONDS ç§’)"
                
                if [ "$LAST_ACTION" = "star" ]; then
                  if [ "$DIFF_SECONDS" -ge "$STAR_PERIOD_SECONDS" ]; then
                    echo "è·ç¦»ä¸Šæ¬¡åŠ æ˜Ÿå·²è¿‡ $DIFF_HOURS å°æ—¶ï¼Œå¯ä»¥å–æ¶ˆæ˜Ÿæ ‡å–µï½"
                    SHOULD_UNSTAR=true
                  else
                    REMAIN_SECONDS=$(( STAR_PERIOD_SECONDS - DIFF_SECONDS ))
                    REMAIN_HOURS=$(awk "BEGIN {printf \"%.2f\", $REMAIN_SECONDS / 3600}")
                    echo "è·ç¦»ä¸Šæ¬¡åŠ æ˜Ÿåªè¿‡äº† $DIFF_HOURS å°æ—¶ï¼Œè¿˜éœ€ç­‰å¾… $REMAIN_HOURS å°æ—¶å–µï½"
                  fi
                else
                  echo "ä¸Šæ¬¡æ“ä½œæ˜¯å–æ¶ˆæ˜Ÿæ ‡ï¼Œä½†ç°åœ¨å·²åŠ æ˜Ÿï¼Œç­‰å¾…æ—¶é—´åå†å–æ¶ˆå–µï½"
                  if [ "$DIFF_SECONDS" -ge "$STAR_PERIOD_SECONDS" ]; then
                    echo "å·²ç­‰å¾…è¶³å¤Ÿæ—¶é—´ï¼Œå¯ä»¥å–æ¶ˆæ˜Ÿæ ‡å–µï½"
                    SHOULD_UNSTAR=true
                  else
                    REMAIN_SECONDS=$(( STAR_PERIOD_SECONDS - DIFF_SECONDS ))
                    REMAIN_HOURS=$(awk "BEGIN {printf \"%.2f\", $REMAIN_SECONDS / 3600}")
                    echo "è¿˜éœ€ç­‰å¾… $REMAIN_HOURS å°æ—¶å–µï½"
                  fi
                fi
              else
                echo "æ²¡æœ‰æ—¶é—´æˆ³è®°å½•ï¼ŒæŒ‰é»˜è®¤å‘¨æœŸå–æ¶ˆæ˜Ÿæ ‡å–µï½"
                SHOULD_UNSTAR=true
              fi
            fi
            
            if [ "$SHOULD_UNSTAR" = "true" ]; then
              echo "æ‰§è¡Œå–æ¶ˆæ˜Ÿæ ‡æ“ä½œ..."
              CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                -X DELETE \
                -H "Authorization: token $PERSONAL_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                https://api.github.com/user/starred/$TARGET_OWNER/$TARGET_REPO)
              if [ "$CODE" = "204" ]; then
                echo "unstar:$NOW" > star_timestamp.txt
                echo "âœ… Unstar æˆåŠŸå¹¶è®°å½•æ—¶é—´æˆ³å–µâ™¡"
              else
                echo "âŒ Unstar å¤±è´¥ï¼Œè¿”å›ç ï¼š$CODE"
                exit 1
              fi
            else
              echo "â­ ç»§ç»­ä¿æŒæ˜Ÿæ ‡çŠ¶æ€å–µï½"
            fi
          fi
          
          # æ˜¾ç¤ºå½“å‰çŠ¶æ€
          if [ -f star_timestamp.txt ]; then
            echo "=== å½“å‰æ—¶é—´æˆ³æ–‡ä»¶å†…å®¹ ==="
            cat star_timestamp.txt
          fi
      
      - name: æäº¤å¹¶æ¨é€æ›´æ–°æ—¶é—´æˆ³æ–‡ä»¶å–µï½
        if: always()
        run: |
          git config user.name "Larch-c"
          git config user.email "tr@wenturc.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet star_timestamp.txt; then
            echo "ğŸ“ star_timestamp.txt æ²¡æœ‰å˜åŒ–ï¼Œä¸éœ€è¦æäº¤å–µï½"
          else
            echo "ğŸ“ star_timestamp.txt æœ‰å˜åŒ–ï¼Œæäº¤æ›´æ–°å–µï½"
            git add star_timestamp.txt
            git commit -m "chore: update star timestamp $(date '+%Y-%m-%d %H:%M:%S') [skip ci]"
            git push
            echo "âœ… æ—¶é—´æˆ³æ–‡ä»¶å·²æ¨é€åˆ°ä»“åº“å–µâ™¡"
          fi
